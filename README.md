# ECS-FARGATE-TERRAFORM

Infrastructure:

Two Worspaces were created in Terraform, being them DEV and PROD in order to deploy the same configuration in a development environment and the other in production. For this, there are some variables that need to be changed in the Terraform settings when the workspace referring to the CDIR block of the VPC and Subnets is changed in order to not have network conflicts between the two environments and thus they are separated in different VPCs.

Each environment has its own VPC and two Public and two Private Subnets. Where the public ones have a default route to the internet gateway and the private ones have an outgoing route to the internet through the NAT Gateway. Each environment has its own repository in the ECR to send Docker images to be used in tasks within the FARGATE service in their respective Clusters. These Tasks do not have a public IP to be accessed only through the Load Balancer connected to the respective services (DEV and PROD) where the Internet output of these Tasks goes via NAT Gateway.

There are two Security Groups for each environment. Being an Internet-facing which the Load Balancer can receive traffic through port 80 coming from the HTTP protocol from the internet and the other Internal which has only one connection rule with the Load Balancer and another with the internal network which the ECS uses this one to not have requests coming directly from the internet and to be able to talk to resources within the same VPC.

Each environment has two Roles that are Execution-Role and Task-Role that are used to have access to execute creation and update calls in Task-Definition as well as to send Logs to LogGroup in Cloudwatch and also to have access to Secret Manager and System Manager so you can safely use environment variables, access keys and tokens in the application. These Roles have the TAGS that each resource has with the name of the application and environment as a condition for access to the SSM and Secrets Manager. In other words, the DEV environment can only access the SSM parameters and the secrets that have these DEV TAGS, just as the PROD environment cannot access the DEV parameters and secrets.

For the build and push of the Docker image to the ECR and Deployment in ECS, a CI/CD pipeline was created with GitHub Actions where the authentication in AWS is done with Open ID Connect (OIDC) so that it is not necessary to pass any authentication key in the time to run the pipeline. For the operation of the OIDC method, a connection was created in IAM through the Provider Identity with GitHub and a Role that will work assuming STS Assume Role so that it can generate the authentication token in the AWS account in order to perform the activities of Push to the Task Definition ECR and Update in order to generate a new Task-Definition revision and thus deploy a new Task in the existing service every time there is a new commit in the repositories referring to the DEV and PROD environments.
